# BER 分析报告

## 概述

本报告分析了 ISO-Texp 真实实验数据集上各增益档位的误码率 (BER)，并评估增益优化算法能否通过调整相机增益来降低通信误码率。

**实验条件**:
- 数据集: ISO-Texp (246 张图片，6 组实验)
- 调制方式: OOK (On-Off Keying)
- 数据包格式: 同步头 (8 bit 全1) + 数据 (32 bit, p32 M 序列)
- 解调方法: 行均值曲线 + 多项式拟合动态阈值 + 游程解码
- 真值来源: `results/base_data/Mseq_32_original.csv` (前 32 bit)
- 增益优化公式 (单次): `G_opt(dB) = G_curr + 20·log10(Y_target / Y_curr)`，目标灰度 `Y_target = 242.25 (255 × 0.95)`

---

## 各实验组 BER vs 增益结果

### 1. bubble / ISO (固定曝光, 变化 ISO)

| 等效增益 (dB) | ISO | BER (均值) | BER (标准差) | ROI 均值 |
|---:|---:|---:|---:|---:|
| -5.8 | 35   | 0.0000 | 0.0000 | 57.4 |
| -2.5 | —    | 0.0000 | 0.0000 | 59.4 |
| +19.4 | — | 0.1667 | 0.1179 | 82.4 |
| +22.8 | — | 0.1823 | 0.0962 | 84.9 |
| +27.4 | — | 0.0208 | 0.0691 | 81.6 |
| +30.7 | — | 0.0938 | 0.1112 | 83.0 |
| +33.4 | — | 0.0729 | 0.1226 | 85.8 |
| +36.8 | — | 0.1250 | 0.1250 | 81.8 |

**优化模拟**: 初始 BER=0 (增益 -5.8 dB)，预测增益 +6.7 dB → 选用 -2.5 dB，BER 维持 0。 ✅ 维持最优。

**规律**: 低增益 (-5.8, -2.5 dB) BER=0；中高增益区间 BER 反而升高，说明气泡环境下信号在低增益时已足够清晰，过高增益导致饱和/失真。

---

### 2. bubble / Texp (固定 ISO, 变化曝光时间)

| 等效增益 (dB) | BER (均值) | BER (标准差) | ROI 均值 |
|---:|---:|---:|---:|
| -5.8 | 0.1649 | 0.2363 | 38.3 |
| -2.5 | 0.0000 | 0.0000 | 66.2 |
| +0.0 | 0.1302 | 0.1074 | 20.5 |
| +1.9 | 0.0833 | 0.1179 | 80.0 |

**优化模拟**:
- 初始增益 -5.8 dB：ROI=38.3，BER=0.1649
- 预测增益 +10.2 dB（超出数据集范围） → 实际选用 +1.9 dB：BER=0.0833
- 数据集最优：-2.5 dB，BER=0.0000
- **BER 改善: +49.5%** ✅

**规律**: BER 在 -2.5 dB 处最低（ROI=66，对比度最好），算法预测方向正确（需要增加增益），受数据集范围限制未能完全达到最优档。

---

### 3. tap water / ISO

| 等效增益 (dB) | BER (均值) | ROI 均值 |
|---:|---:|---:|
| -5.8  | 0.0000 | 86.6  |
| +13.4 | 0.0000 | 96.3  |
| +19.4 | 0.0000 | 85.0  |
| +23.3 | 0.0000 | 91.5  |
| +27.4 | 0.0833 | 102.4 |
| +31.3 | 0.1042 | 108.1 |
| +33.4 | 0.1771 | 101.3 |

**优化模拟**: 初始 BER=0 (增益 -5.8 dB)，预测 +3.1 dB → 选用 -5.8 dB，维持 BER=0。 ✅ 维持最优。

**规律**: 自来水环境透光好，低增益下即可实现 BER=0。过高增益 (>27 dB) BER 开始上升（图像接近饱和，对比度下降）。

---

### 4. tap water / Texp

| 等效增益 (dB) | BER (均值) | ROI 均值 |
|---:|---:|---:|
| -5.8 | 0.0000 | 87.1  |
| -2.5 | 0.0000 | 100.9 |
| +1.9 | 0.0417 | 100.2 |
| +4.8 | 0.0833 | 112.7 |

**优化模拟**: 初始 BER=0，ROI=87.1，算法预测 +3.1 dB → 选用 +1.9 dB，BER 升至 0.0417。

⚠️ **过冲** (Overshoot): 初始增益已处于最优区间，算法仍预测需要更高增益，导致工作点偏移到次优区域。

---

### 5. turbidity / ISO

| 等效增益 (dB) | BER (均值) | ROI 均值 |
|---:|---:|---:|
| -5.8  | **0.4948** | **0.0** |
| +19.4 | 0.0000 | 85.8  |
| +33.4 | 0.0000 | 112.0 |

**优化模拟**:
- 初始增益 -5.8 dB：ROI≈0 (图像全黑)，BER=0.4948（接近随机猜测 0.5）
- 预测增益 +68.8 dB → 超出数据集，选用最高 +33.4 dB：BER=0.0000
- **BER 改善: +100%** ✅

**规律**: 浑浊水体对光线衰减极大，最低增益下图像几乎为黑。增益优化准确识别出严重欠曝光，大幅提升增益后 BER 从 0.5 降到 0，效果最显著。

---

### 6. turbidity / Texp

| 等效增益 (dB) | BER (均值) | ROI 均值 |
|---:|---:|---:|
| -5.8 | 0.0000 | 86.6 |
| -2.5 | 0.0000 | 90.9 |
| +0.0 | 0.0000 | 90.0 |
| +1.9 | 0.0208 | 93.8 |

**优化模拟**: 初始 BER=0，算法预测 +3.1 dB → 选用 +1.9 dB，BER 升至 0.0208。

⚠️ **轻微过冲**（与 tap water/Texp 类似）。

---

## 汇总对比

| 实验 | 初始 BER | 优化后 BER | 数据集最优 BER | 结果 |
|---|---:|---:|---:|---|
| bubble / ISO      | 0.0000 | 0.0000 | 0.0000 | ✅ 维持最优 |
| **bubble / Texp** | 0.1649 | 0.0833 | 0.0000 | ✅ 改善 49.5% |
| tap water / ISO   | 0.0000 | 0.0000 | 0.0000 | ✅ 维持最优 |
| tap water / Texp  | 0.0000 | 0.0417 | 0.0000 | ⚠️ 轻微过冲 |
| **turbidity / ISO** | 0.4948 | 0.0000 | 0.0000 | ✅ **改善 100%** |
| turbidity / Texp  | 0.0000 | 0.0208 | 0.0000 | ⚠️ 轻微过冲 |

---

## 结论

### 算法有效性

1. **严重欠曝光时效果最显著** (`turbidity/ISO`): ROI 均值≈0，BER≈0.5（近乎随机）。算法识别出欠曝光并大幅提升增益，BER 降至 0 → **改善 100%**。

2. **中等欠曝光时有效** (`bubble/Texp`): 初始 BER=0.165，优化后降至 0.083 → **改善 49.5%**。若数据集增益范围更宽，可进一步达到 BER=0。

3. **初始已最优时维持性能** (`bubble/ISO`, `tap water/ISO`): 算法预测增益接近初始值，BER 维持 0，不引入额外误差。

### 过冲问题

在 `tap water/Texp` 和 `turbidity/Texp` 两组，初始 BER 已为 0，但 ROI 均值（~87）仍低于目标值（242.25），算法预测仍需增加约 3 dB 增益，导致工作点移到次优区（BER 轻微上升 0.02~0.04）。

**根本原因**: "ROI 灰度接近 255" 与 "BER 最低" 并不完全等价。图像对比度（条纹亮暗差）才是决定 BER 的关键，而非绝对亮度。在某些条件下，较低的绝对亮度但高对比度已经足以实现 BER=0。

### 改进建议

- **增加停止条件**: 若当前 BER 已为 0，停止优化，避免过冲
- **使用眼图开度作为辅助指标**: 当信号 SNR（亮行均值 vs 暗行均值之差）达到阈值时停止
- **限制单次预测步长**: 添加最大步长限制（如 ±10 dB），防止 ROI≈0 时预测过大增益

---

## 可视化输出

| 文件 | 内容 |
|---|---|
| [ber_vs_gain_curves.png](ber_vs_gain_curves.png) | 各组 BER vs 增益曲线（含初始/预测/最优标注） |
| [ber_comparison_bar.png](ber_comparison_bar.png) | 各组初始/优化后/最优 BER 柱状图对比 |
| [ber_analysis_summary.csv](ber_analysis_summary.csv) | 数值汇总表 |

**分析脚本**: [`scripts/ber_vs_gain_analysis.py`](../../scripts/ber_vs_gain_analysis.py)

---

*生成时间: 2026-02-28*
